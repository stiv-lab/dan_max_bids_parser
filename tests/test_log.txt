➜  repo_dan_max_bids_parser git:(feat/mvp-sqlalchemy-uow) ✗ poetry run pytest tests
================================================= test session starts ==================================================
platform linux -- Python 3.11.14, pytest-9.0.1, pluggy-1.6.0
rootdir: /root/projects/repo_dan_max_bids_parser
configfile: pyproject.toml
plugins: asyncio-1.3.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 17 items

tests/application/test_run_source_harvesting_interface.py .                                                      [  5%]
tests/application/test_unit_of_work_contract.py .                                                                [ 11%]
tests/db/test_db_base.py ..                                                                                      [ 23%]
tests/db/test_initial_schema.py ...                                                                              [ 41%]
tests/db/test_models_metadata.py .                                                                               [ 47%]
tests/db/test_repositories_basic_crud.py ...                                                                     [ 64%]
tests/db/test_unit_of_work_sqlalchemy.py FFF                                                                     [ 82%]
tests/domain/test_entities_basic.py ...                                                                          [100%]

======================================================= FAILURES =======================================================
___________________________________________ test_uow_commit_persists_changes ___________________________________________

    def test_uow_commit_persists_changes():
        """
        Проверяем, что при явном commit() данные фиксируются в БД.

        Здесь мы сознательно работаем напрямую с ORM-моделью Source через
        uow.session, чтобы протестировать транзакционное поведение
        SqlAlchemyUnitOfWork, а не контракт репозитория (он покрыт
        отдельными тестами в test_repositories_basic_crud.py).
        """
        SessionFactory = _make_session_factory()
        uow = SqlAlchemyUnitOfWork(session_factory=SessionFactory)

        with uow:
            src = Source(
                code="TEST_SRC",
                name="Test Source",
                kind="html",
                # остальные поля полагаемся на значения по умолчанию
            )
            uow.session.add(src)
            uow.commit()

        # Новая сессия: читаем напрямую через репозиторий,
        # чтобы убедиться, что данные действительно зафиксированы.
        with SessionFactory() as session:
            repo = SqlAlchemySourceRepository(session)
>           sources = list(repo.list())
                           ^^^^^^^^^
E           AttributeError: 'SqlAlchemySourceRepository' object has no attribute 'list'

tests/db/test_unit_of_work_sqlalchemy.py:53: AttributeError
______________________________________ test_uow_without_commit_rolls_back_changes ______________________________________

    def test_uow_without_commit_rolls_back_changes():
        """
        Проверяем, что без commit() изменения не попадают в БД.

        Внутри контекста добавляем объект в сессию, но не вызываем commit().
        При выходе из контекста UoW должен сделать rollback().
        """
        SessionFactory = _make_session_factory()
        uow = SqlAlchemyUnitOfWork(session_factory=SessionFactory)

        with uow:
            src = Source(
                code="NO_COMMIT",
                name="No Commit Source",
                kind="html",
            )
            uow.session.add(src)
            # commit() намеренно не вызываем

        with SessionFactory() as session:
            repo = SqlAlchemySourceRepository(session)
>           sources = list(repo.list())
                           ^^^^^^^^^
E           AttributeError: 'SqlAlchemySourceRepository' object has no attribute 'list'

tests/db/test_unit_of_work_sqlalchemy.py:79: AttributeError
____________________________________________ test_uow_rollback_on_exception ____________________________________________

    def test_uow_rollback_on_exception():
        """
        Проверяем, что при исключении внутри контекста все изменения откатываются.

        Внутри вложенного with uow: добавляем объект и затем выбрасываем
        исключение. UoW обязан выполнить rollback().
        """
        SessionFactory = _make_session_factory()
        uow = SqlAlchemyUnitOfWork(session_factory=SessionFactory)

        with pytest.raises(RuntimeError):
            with uow:
                src = Source(
                    code="WITH_EXCEPTION",
                    name="Broken Source",
                    kind="html",
                )
                uow.session.add(src)
                # Искусственно ломаем выполнение
                raise RuntimeError("boom")

        with SessionFactory() as session:
            repo = SqlAlchemySourceRepository(session)
>           sources = list(repo.list())
                           ^^^^^^^^^
E           AttributeError: 'SqlAlchemySourceRepository' object has no attribute 'list'

tests/db/test_unit_of_work_sqlalchemy.py:107: AttributeError
=============================================== short test summary info ================================================
FAILED tests/db/test_unit_of_work_sqlalchemy.py::test_uow_commit_persists_changes - AttributeError: 'SqlAlchemySourceRepository' object has no attribute 'list'
FAILED tests/db/test_unit_of_work_sqlalchemy.py::test_uow_without_commit_rolls_back_changes - AttributeError: 'SqlAlchemySourceRepository' object has no attribute 'list'
FAILED tests/db/test_unit_of_work_sqlalchemy.py::test_uow_rollback_on_exception - AttributeError: 'SqlAlchemySourceRepository' object has no attribute 'list'
============================================= 3 failed, 14 passed in 0.46s =============================================
➜  repo_dan_max_bids_parser git:(feat/mvp-sqlalchemy-uow) ✗