# 1. Обзор проекта и цели

Система Дан-Макс — универсальная платформа для автоматического сбора, нормализации, классификации, фильтрации и хранения заявок на перевозку сыпучих материалов из различных источников:

- веб-сайты (ATI, Perevozka24, Samosval.info и др.),
- Telegram-каналы и группы,
- потенциально WhatsApp и API-источники.

Цели системы:

1. **Автоматизировать ручной поиск заявок**.
2. **Обеспечить масштабирование** до 20–40 источников.
3. **Сделать систему конфигурируемой без деплоя**.
4. Подготовить платформу для аналитики, экспорта и интеграций.

Архитектура описана в документе:  
`docs/architecture/architecture_overview.md`

Диаграммы:  
`docs/architecture/dan_max_diagrams.md`

Техническое задание:  
(ссылка на ТЗ из репо или внешний файл).

---

# 2. Разделение проекта на этапы

Проект реализуется в два крупных этапа:

1. **Этап 1 — MVP**  
   Минимальная работоспособная версия, включающая фундаментальные элементы системы и ограниченный набор источников (2 сайта, 1–2 Telegram-группы).

2. **Этап 2 — Полная реализация**  
   Масштабирование до 20–40 источников, Web UI, расширенный антибот, мониторинг, очереди задач, интеграции.

Обе части опираются на те же архитектурные принципы.

---

# 3. Этап 1 — MVP (миним viable product)

## 3.1. Цели MVP

MVP считается реализованным, если выполнены:

- Корректный ETL-пайплайн.
- Хранение данных в PostgreSQL + конфиг-слой в БД.
- Поддержка 2 сайтов + 1–2 Telegram-источников.
- Фильтрация по типу груза.
- Дедупликация.
- Экспорт в XLSX/Google Sheets.
- Авто-запуск по расписанию.
- Уведомления в Telegram при сбоях.

---

## 3.2. Блок A — Базовая инфраструктура

### A1. Репозиторий и окружение
- Структура проекта (clean architecture).
- Poetry, Dockerfile, docker-compose.
- Настройка CI (линтеры, тесты).

### A2. База данных + миграции
- Таблицы:
  - `sources`
  - `raw_items`
  - `bids`
  - `jobs`
  - `errors`
  - `config_*` (все управляемые сущности)
- Alembic (только схема, без данных).

### A3. Конфигурационный слой (без деплоя)
- `SourceConfig`
- `ClassifierConfig`
- `FilterRuleConfig`
- `DeduplicationConfig`
- `ScheduleConfig`
- `AntiBotProfiles`
- `ExportConfig`

---

## 3.3. Блок B — ETL-ядро

### Компоненты:

1. **Extract**  
   – RawItemProvider  
   – HTTP-клиент  
   – базовые антибот-механизмы (UA-ротация, задержки)

2. **Parse**  
   – HTML → RawItem  
   – Telegram → RawItem  

3. **Normalize**  
   – даты, цены, маршруты, телефоны  

4. **Classify**  
   – словари типов грузов  
   – конфиг из БД  

5. **Filter**  
   – обязательная фильтрация по типу груза  
   – опциональная по маршруту / цене  

6. **Deduplicate**  
   – конфигурируемая стратегия  

7. **Store**  
   – репозитории  
   – транзакционное сохранение  

### Результат:  
Полный, универсальный ETL-пайплайн.

---

## 3.4. Блок C — Первые адаптеры источников

### Сайты (2 шт):
- ATI или Perevozka24 — в качестве основного бенчмарка.
- Samosval.info или альтернативный — второй HTML-источник.

### Telegram (1–2 группы):
- Telethon или Aiogram listener.
- Парсер текста и вложений.
- Идентификация заявок по ключевым словам.

---

## 3.5. Блок D — Scheduler & Worker

- APScheduler или cron.
- Поддержка ScheduleConfig:
  - интервал,
  - отдельное расписание для каждого источника.
- Use cases:
  - `RunSourceHarvesting(source_id)`
  - `ReprocessRawItems()`
  - `CleanupOldRawItems()`

---

## 3.6. Блок E — Экспорт и уведомления

- Экспорт XLSX (формат 13 колонок из ТЗ).
- Экспорт в Google Sheets.
- Telegram-уведомления:
  - критические ошибки,
  - недоступность источника.

---

## 3.7. Блок F — Документация MVP

- «Как развернуть систему».
- «Как добавить новый источник».
- Структура таблиц.
- Описание конфига.

---

# 4. Этап 2 — Полная реализация

## 4.1. Цели Этапа 2

- Масштабирование до 20–40 источников.
- Поддержка сайтов со сложными антибот-схемами.
- Web UI.
- Полный мониторинг.
- Очереди задач.
- Повышение надёжности и отказоустойчивости.

---

# 4.2. Блок A — Массовое подключение сайтов

### 10–20 HTML-источников:
- ATI (расширенный режим)
- Perevozka24
- Samosval.info
- Auto.proms.ru
- TIU
- ГрузоБазар
- прочие из ТЗ

### API-источники (если появятся)
- Поддержка APISiteAdapter.

### WhatsApp (по тех. возможности)
- Отдельный анализ feasibility.
- Подключение только после подтверждения.

---

# 4.3. Блок B — Anti-bot Layer 2.0

- ProxyManager с поддержкой:
  - Datacenter proxies
  - Residential proxies
  - Mobile proxies
- RequestThrottler (динамическая скорость)
- Randomized behavior
- Полная конфигурируемость в БД
- CAPTCHA-решатель (опционально)

---

# 4.4. Блок C — Web UI

Функции:

1. Просмотр списка заявок.
2. Фильтры и сортировка.
3. Управление источниками:
   - включение/выключение,
   - расписания,
   - настройки антибота.
4. Просмотр логов.
5. Экспорт.
6. Мониторинг воркеров.

Технологии:
- FastAPI backend
- React/Vue frontend

---

# 4.5. Блок D — Мониторинг & отчётность

- Telegram-уведомления:
  - ошибка,
  - отсутствие новых заявок более X часов,
  - увеличение времени обработки.
- Отчёты:
  - ежедневные статистики,
  - распределение по источникам,
  - количество дублей.
- Метрические системы:
  - Prometheus
  - Grafana

---

# 4.6. Блок E — Масштабирование

- Очередь задач: Celery / RQ + Redis.
- Параллельная обработка сайтов.
- Горизонтальное масштабирование адаптеров.
- Оптимизация БД:
  - индексы,
  - партиционирование (опционально),
  - очистка старых данных.

---

# 4.7. Блок F — Документация

- Руководство оператора Web UI.
- Руководство разработчика.
- Документ по антибот-слою.
- Полная схема конфигурации.

---

# 5. Хронология реализации (рекомендованная)

## Этап 1 — MVP (4–6 недель)

### Недели 1–2
- Базовая архитектура.
- БД + миграции.
- Конфигурационный слой.
- Extract/Parse.

### Неделя 3
- Normalize / Classify / Filter / Deduplicate.
- Первый HTML-источник.

### Неделя 4
- Telegram-адаптер.
- Scheduler.
- Store.

### Неделя 5
- Экспорт.
- Уведомления.
- Базовая документация.

### Неделя 6 (буфер)
- Финальные тесты.
- Оптимизация.

---

## Этап 2 — Основная часть (8–14 недель)

### Недели 1–3
- Подключение новых сайтов.
- Автоматизация шаблонов адаптеров.

### Недели 4–6
- Anti-bot 2.0.
- ProxyManager.

### Недели 7–10
- Web UI.
- REST API.

### Недели 11–12
- Мониторинг.
- Отчётность.

### Недели 13–14 (буфер)
- Производительность.
- Финальное тестирование.

---

# 6. Связь с GitHub Issues / Projects

Рекомендуемая структура:

1. **Milestone: MVP**
   - Epic: Infrastructure
   - Epic: ETL Core
   - Epic: Source Adapters MVP
   - Epic: Scheduler MVP
   - Epic: Export & Alerts
   - Epic: Docs MVP

2. **Milestone: Full Release**
   - Epic: 20–40 Sources
   - Epic: Anti-bot 2.0
   - Epic: Web UI
   - Epic: Monitoring
   - Epic: Scaling & Workers
   - Epic: Documentation (Full)

Каждый Epic содержит Issues, связанные с документами из `docs/specs/*`.

---

# 7. Политика обновления плана

- План обновляется после завершения каждого блока MVP/Phase 2.
- Изменения фиксируются в PR.
- При изменении архитектуры — обязательная синхронизация с арх.документами.

---

# 8. Итог

Этот документ является:
- компасом проекта,
- основой для планирования,
- точкой синхронизации всех участников,
- местом, откуда начинаются все новые задачи (via specs + issues).

При необходимости может быть дополнен конкретными календарными сроками и ответственными.
